# IR_wine

## Постановка задачи
Обучить нейросетевую модель предсказывать концентрации этанола (об.%), сахара (сахарозы+фруктозы, г/л), кислот (г/л), глицерина (г/л) и диоксида серы (г/л) в белых и красных винах.
Обучение модели проводится на данных спектроскопии ИК-поглощения растворов, моделирующих вина (См. п."Объекты исследования").
Такой подход позволяет экспериментально получить набор спектров ИК с известными концентрациями основных компонент вин для дальнейшего обучения нейронных сетей. 

![TOC](https://github.com/user-attachments/assets/a4b0c0a7-98c9-43d6-9350-8886728d04b0)


## Объекты исследования
1. Модельные растворы

В качестве модельных использовались водные растворы, содержащие **этанол**, смесь **глюкозы**, **фруктозы** и **сахарозы** (в соотношении 45:45:10), **винную**, **яблочную** и **лимонные кислоты** (в соотношении 40:40:20), глицерин и диоксид серы. Диапазоны изменения концентраций указанных компонентов в модельных растворах выбраны в соответствии с ГОСТ РФ 32030-2021 и приведены в Таблице 1. 

Модельные растворы были приготовлены из следующих базовых растворов в воде:

-- раствор этанола 60% (90 мл этанола + 60 мл воды),

--раствор сахара, 500 г/л (22.5 г глюкозы + 22.5 г фруктозы + 5 г сахарозы на 100 мл раствора),

раствор кислот, 250 г/л (2 г винной + 2 г яблочной + 1.094 г лимонной на 20 мл раствора),

-- раствор глицерина, 250 г/л (12.5 г на 50 мл раствора),

-- раствор SO<sub>2</sub>, 10 г/л (0.521 г соли K<sub>2</sub>S<sub>2</sub>O<sub>5</sub> на 30 мл раствора). 

Следует заметить, что в образце модельного вина, как и в реальных винах, всегда предполагается присутствие всех выбранных компонент (т.е. раствор всегда 5-компонентный). 
  
2. Образцы вина
  
  ![image](https://github.com/oesarmanova/IR_wine/assets/79655674/0118ec7c-04b2-45c7-bc75-08a433f564de)

Рис.1. Фотография образцов белых и красных вин.

## Приготовление модельных растворов

ТАБЛИЦА 1.

| Компонент  | Концентрации |
| ------------- | ------------- |
| Этанол (об.%)  | 8; 10; 12; 14; 18  |
| Сахар (г/л)  | 10; 25; 50; 100; 200  |
| Кислоты (г/л)  | 3; 6; 8; 10; 12  |
| Глицерин (г/л)  | 5; 10; 15; 20; 25 |
| Диоксид серы (г/л)  | 0.1; 0.2; 0.3; 0.5; 1  |

## Экспериментальное оборудование

### Измерение спектров ИК-поглощения модельных растворов

Измерения проводились на Фурье ИК спектрометре Bruker Invenio R в схеме НПВО (в режиме однократного отражения) в системе с прокачкой пробы и последующим промыванием системы водой. Спектры регистрировались в диапазоне 400-8000 см<sup>-1</sup> с шагом 2 см<sup>-1</sup>. При дальнейшей обработке спектров рассматривался диапазон 400 – 4000 см<sup>-1</sup>. Для каждого спектра делалось 16 сканов с водой в качестве фона в режиме измерения поглощения с атмосферной коррекцией. После регистрации спектра ИК каждой пробы система сначала продувалась воздухом и промывалась водой (примерно по 5-10 мл два раза), затем демонтировалась система прокачки, приборный столик последовательно протирался сухой салфеткой, спиртом, водой. Далее регистрировался спектр воды относительно ранее зарегистрированного фона для контроля качества промывки системы, затем спектр воды регистрировался в качестве фона. Далее в систему заливалась новая проба следующим образом: 1 мл пробы использовался для промывки системы, затем 1 мл пробы заливался в систему, его спектр ИК-поглощения измерялся.

![image](https://github.com/oesarmanova/IR_wine/assets/79655674/9c1ea92c-98f2-4bfe-8975-473b0f0c50c0)

Рис.2. ИК-Фурье спектрометр Bruker.

![Рисунок1](https://github.com/user-attachments/assets/53cbbf7d-1520-49de-a4d3-594eeaeccd5c)

Рис.3. Схема проведения измерений спектров ИК-поглощения в системе прокачки.

### Измерение концентраций компонентов модельных растворов с помощью аналитических методов.

В качестве независимого метода оценки концентрации сахара, этанола, органических кислот, глицерина и диоксида серы в реальных винах применялись газовая хроматография (ГХ) с парофазным анализом и высокоэффективная жидкостная хроматография (ВЭЖХ) с рефрактометрическим детектором. Измерения проводились в Испытательном Центре МГУ ЛАБ.
Содержание этанола и глицерина определялось ГХ. Содержание кислот – методом ВЭЖХ. Следует отметить, что полная диагностика даже 5 компонент вызвала сложности при измерениях химическими методами: потребовалось несколько различных методов с соответствующими приборами и несколько дней непосредственных измерений. 


## Набор данных

Исходный набор данных: 1734 примера

Набор данных после чистки: 1710 примеров 

Число признаков: 1868. Соответствуют диапазону 400 – 4000 смсм<sup>-1</sup>.

Количество целевых переменных: 5. Диапазоны изменения концентраций 5 компонентов соответствуют величинам, указанным в Таблице 1. 

### Удаление выбросов

Удаление выбросов происходило на основе анализа проекции набора данных в пространство первых трех главных компонент (анализ главных компонент) b поканальных статистических показателей массива данных (минимальное, максимально, медианное и среднее значение признака в спектральном канале).


До удаления выбросов:
![pca_raw](https://github.com/user-attachments/assets/13094570-4618-44f7-8d57-ebd602c930f3)

Проекция набора данных в пространство первых трех главных компонент до удаления выбросов.

Поскольку спектры поддаются кластеризации только для случаев определения этанола и сахаров, чистку данных проводили с помощью графиков счетов для данных компонент раствора.

После удаления выбросов:
![photo_2024-08-28_17-57-58](https://github.com/user-attachments/assets/7901fd35-e16d-440c-81d3-ff6452909945)

Проекция набора данных в пространство первых трех главных компонент после удаления выбросов.

![image](https://github.com/user-attachments/assets/9ce52229-1c2a-473c-9d31-5b50dd32774f)


## Вина

Для апробации разработанного метода диагностики вин обученные на модельных растворах методы машинного обучения предполагалось применить к спектрам ИК-поглощения 10 реальных вин. Характеристики вин указаны в Таблице 2.

Таблица 2. Характеристики реальных вин, использованные в исследовании. 

![р_вина](https://github.com/user-attachments/assets/f95351a0-a367-4908-a534-d3d57c99493a)

## Методы машинного обучения для предсказания концентрации целевых параметров

ПЛС (Реализация wines_ir_pls_basic.ipynb)

Метод проекций на латентные структуры (ПЛС) относится к так называемым проекционным методам и является одним из самых популярных методов многомерной калибровки. Метод заключается в проецировании значений признаков (спектров) и предсказываемых параметров (концентраций) в пространство, базис которого построен на векторах, определяющих направление максимальной дисперсии в данных. Причем проецирование осуществляется согласованно для признаков и целевых переменных так, чтобы максимизировать корреляцию между соответствующими проекциями признаков и целевых параметров в новом пространстве [R. Wehrens, B.H. Mevik. “The pls package: principal component and partial least squares regression in R”. Journal of Statistical Software 2007. 18(2): 1-23].

Оптимальная размерность нового (латентного) пространства или количество компонент, адекватно описывающих зависимости в данных после их сжатия, должно подбираться для каждой конкретной задачи.
В настоящей работе был применен следующий подход: набор спектров, измеренных в системе прокачки, разбивался на тренировочный, валидационный и тестовый в соотношении 7:2:1. Тренировочный набор использовался для настройки параметров ПЛС модели, а тестовый для оценки качества решения задачи. Валидационный набор никак не использовался. Подобное разбиение было сделано для корректности сравнения полученных результатов с результатами обучения нейросетевых моделей, для обучения которых нужен валидационный набор. Разбиение проводилось случайным образом, и чтобы избежать влияния способа разбиения данных на наборы, эта процедура (кросс-валидация) была проведена 8 раз.
Задача решалась отдельно для каждого целевого параметра (концентрации этанола, сахаров, кислот, глицерина и диоксида серы), причем размерность латентного пространства варьировалась от 1 до 100. Для каждого вещества было определено количество компонент, соответствующих минимальным значениям САО на тестовом наборе данных. Так, для определения концентрации этанола была использована 31 компонента, для сахаров – 11 компонент, для кислот – 18 компонент, для глицерина – 19 компонент, для диоксида серы – 48 компонент.

МСП (Реализация wines_ir_mlp_basic.ipynb)

Использованные МСП имели 1 скрытый слой с 128 нейронами, сигмоидальной функцией активации в скрытом слое и линейной у единственного нейрона выходного слоя. В качестве оптимизационного использовался алгоритм adam [Kingma, D. P., & Ba, J. (2014). Adam: A method for stochastic optimization. arXiv preprint arXiv:1412.6980], скорость обучения составляла 0.001, функция потерь MSE, регуляризация L2, параметр регуляризации 0.001 Для оценки погрешности решения использовались 8-кратная кросс-валидация и 5-кратная инициализация весов модели.

СНС (Реализация CNN_predict_ethanol.ipynb)

В вычислительном эксперименте использовались 1D свёрточные нейронные сети (СНС). СНС имели 2 свёрточных слоя (ядро свёртки/фильтр = 9 спектральных каналов, stride=1, padding = 0, число выходных каналов 2 и 4, соответственно), функции активации – сигмоида. За каждым свёрточным слоем следовал слой пулинга, который в два раза уменьшал карты признаков. Таким образом, на выходе свёрточных слоев модель имела 1844 нейрона. Далее следовал линейный слой (полносвязный), содержащий 64 нейрона с сигмоидальной функцией активации. В выходном слое каждой сети находился 1 нейрон с линейной функцией активации. Использовался оптимизатор adam, скорость обучения 0.001, функция потерь MSE, регуляризация L2, параметр регуляризации 0.001. Для оценки погрешности решения использовались 8-кратная кросс-валидация и 5-кратная инициализация весов модели.
Обучение нейросетевых моделей (МСП и СНС) моделей осуществлялось на тренировочном наборе, для остановки обучения использовался валидационный набор (обучение останавливалось, если среднеквадратичная ошибка на данном наборе не уменьшалась в течение 100 эпох для МСП и 250 эпох для СНС), окончательная оценка эффективности модели проводилась на новых, ранее не использованных данных – тестовом наборе.

## Предсказание концентрации компонентов модельных растворов

На первом этапе для определения концентраций 5 компонентов вин в модельных растворах были использованы 3 алгоритма анализа данных: метод ПЛС-регрессии, МСП и СНС (Подробнее см. п.2). Для этого они были применены к набору спектров ИК-поглощения модельных растворов, полученных в схеме измерений в системе прокачки (1734 примера). Результаты применения натренированных на тренировочных поднаборах (1203 примера) моделей к примерам из тестовой выборки (173 примера) представлены на Рис.8.

![image](https://github.com/user-attachments/assets/4d86b4d3-2117-4800-a583-c26703aff351)

Анализируя исключительно САО определения концентрации компонента, отнесенные к диапазону изменения концентрации компонента в наборе данных для трех моделей (ПЛС-р, МСП и СНС) (Рис.8а) можно было бы прийти к заключению, что вопреки утверждениям о непригодности линейных методов хемометрики для анализа многокомпонентных жидких сред, ПЛС-р демонстрирует САО предсказания концентраций всех исследуемых компонентов модельных растворов меньшую, чем МСП, а в случае этанола и SO2 – меньшую, чем МСП и СНС. Данный вывод, казалось бы, делает применение НС для решения задачи совершенно необоснованным. Тем не менее, обратимся к Рис.8б, который демонстрирует увеличение ошибки определения концентрации компонентов на тестовом наборе относительно тренировочного набора. Данный результат свидетельствует о значительном переобучении моделей ПЛС-р и СНС для всех компонентов: САО на тестовом наборе данных в среднем на 41.7 % и 30 % превышает соответствующую величину на тренировочном наборе данных для всех компонентов для ПЛС-р и СНС, соответственно.  Это свидетельствует о том, что параметры модели подстраиваются таким образом, чтобы «запоминать» тренировочный набор данных вместо того, чтобы находить закономерности в данных. Переобучение модели приводит снижению качества решения задачи на данных, отличающихся от примеров из тренировочного набора. И в этом смысле МСП, казалось бы, должен решать задачу на новых данных лучше остальных алгоритмов.
Для апробации разработанного метода диагностики вин обученные на модельных растворах модели ПЛС-р, МСП и СНС были применены к спектрам ИК поглощения 10 реальных вин. В Таблице 3 представлены значения концентраций 5 компонентов реальных вин, полученные в результате применения к их спектрам ИК поглощения моделей ПЛС-р, МСП и СНС, обученных на модельных винах. Указанные концентрации являются результатом усреднения ответов 40 сетей, соответствующих 8-кратной кросс-валидации и 5-кратной инициализации весов модели внутри каждого разбиения (для МСП и СНС), и 8 моделей ПЛС-р, соответствующих 8-кратной кросс-валидации.
В этих же 10 реальных винах были измерены концентрации некоторых компонент – этанола, кислот и глицерина – независимыми химическими методами. Содержание этанола и глицерина определялось газовой хроматографией с парофазным анализом, содержание кислот – методом ВЭЖХ с рефрактометрическим детектором. Следует отметить, что полная диагностика даже 5 компонент вызвала достаточно большие сложности при измерениях химическими методами: потребовалось несколько различных методов с соответствующими приборами и несколько дней непосредственных измерений. Результаты измерения концентраций компонентов альтернативными методами также указаны в Таблице 3. 

Таблица 3. Результаты измерения концентраций этанола, сахаров, кислот, глицерина и диоксида серы с помощью ГХ, ВЭЖХ и ИК-спектроскопии с применением различных ММО: ПЛС, МСП и СНС.

![image](https://github.com/user-attachments/assets/eec91a42-cc5a-4955-af6f-1ea8a54ad28e)

Анализ полученных результатов позволяет заключить, что несмотря на переобученность, СНС демонстрируют лучший результат предсказания исследуемых компонентов среди использованных моделей МО: все результаты предсказания концентрации этанола в реальных винах совпали с результатами измерения ГХ в пределах погрешности. САО определения этанола в вине составила 0.36 об.%. Это означает, что разработанный подход обеспечивает мониторинг этанола с удовлетворительными для нужд производства точностями.

![image](https://github.com/user-attachments/assets/a5145873-f59f-4e5e-baa6-e06f66ff614a)

К сожалению, определение диоксида серы является проблемой для любых измерений, так как этот компонент чрезвычайно летуч. В связи с этим в документации по нормам содержания компонентов в винах указывается содержание диоксида серы < 0.3 г/л.
